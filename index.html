<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🚀 API POS SalesHourly v2.5 Testing Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Fira+Code:wght@300;400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    :root { 
      --primary: #3498db; 
      --secondary: #2c3e50; 
      --success: #27ae60;
      --warning: #f39c12;
      --danger: #e74c3c;
      --info: #17a2b8;
      --light: #f8f9fa;
      --dark: #343a40;
      --bg: #f5f7fa; 
      --card: #ffffff; 
      --text: #2c3e50; 
      --text-muted: #6c757d;
      --border: #dee2e6;
      --border-radius: 12px; 
      --padding: 20px; 
      --shadow: 0 4px 16px rgba(0,0,0,0.1);
      --shadow-hover: 0 8px 24px rgba(0,0,0,0.15);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    [data-theme="dark"] {
      --bg: #1a1a1a;
      --card: #2d2d2d;
      --text: #ffffff;
      --text-muted: #adb5bd;
      --border: #495057;
      --secondary: #495057;
    }
    
    * { box-sizing: border-box; }
    
    body { 
      margin: 0; 
      font-family: 'Inter', 'Segoe UI', 'Roboto', sans-serif; 
      background: var(--bg); 
      color: var(--text); 
      line-height: 1.6;
      font-size: 14px;
      transition: var(--transition);
    }
    
    .container { 
      max-width: 1400px; 
      margin: 0 auto; 
      padding: var(--padding); 
    }
    
    .header {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 24px 0;
      margin-bottom: 32px;
      box-shadow: var(--shadow);
    }
    
    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    h1 { 
      margin: 0;
      font-weight: 700; 
      font-size: 2rem;
      background: linear-gradient(45deg, #fff, #e3f2fd);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .theme-toggle {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 10px 16px;
      border-radius: 24px;
      cursor: pointer;
      font-size: 14px;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .theme-toggle:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-1px);
    }
    
    .card { 
      background: var(--card); 
      border-radius: var(--border-radius); 
      padding: var(--padding); 
      margin-bottom: 24px; 
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }
    
    .card:hover {
      box-shadow: var(--shadow-hover);
      transform: translateY(-2px);
    }
    
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--success));
    }
    
    .card h2 { 
      margin-top: 0; 
      margin-bottom: 16px;
      color: var(--secondary); 
      font-weight: 600;
      font-size: 1.25rem;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .card h2::before {
      content: attr(data-icon);
      font-size: 1.5rem;
    }
    
    .grid-2 { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 20px; 
    }
    
    .grid-3 { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
      gap: 16px; 
    }
    
    @media (max-width: 768px) { 
      .grid-2, .grid-3 { grid-template-columns: 1fr; }
      .header-content { flex-direction: column; gap: 16px; text-align: center; }
      h1 { font-size: 1.5rem; }
      .container { padding: 16px; }
    }
    
    .form-group {
      position: relative;
      margin-bottom: 20px;
    }
    
    label { 
      display: block; 
      margin-bottom: 6px; 
      font-weight: 500;
      color: var(--text);
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .required { color: var(--danger); }
    
    input[type=text], input[type=password], input[type=date], input[type=number], input[type=file], textarea, select { 
      width: 100%; 
      padding: 12px 16px; 
      border: 2px solid var(--border); 
      border-radius: 8px; 
      font-family: inherit; 
      font-size: 14px;
      background: var(--card);
      color: var(--text);
      transition: var(--transition);
      margin-bottom: 4px;
    }
    
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
      transform: translateY(-1px);
    }
    
    input:invalid:not(:focus) {
      border-color: var(--danger);
    }
    
    input:valid:not(:focus):not([value=""]) {
      border-color: var(--success);
    }
    
    textarea { 
      height: 120px; 
      resize: vertical; 
      font-family: 'Fira Code', monospace;
      font-size: 12px;
    }
    
    .btn {
      background: var(--primary); 
      color: #fff; 
      border: none; 
      padding: 12px 20px; 
      border-radius: 8px; 
      font-size: 14px; 
      font-weight: 500;
      cursor: pointer; 
      margin: 4px 4px 4px 0; 
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
      position: relative;
      overflow: hidden;
    }
    
    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }
    
    .btn:hover::before {
      left: 100%;
    }
    
    .btn:hover { 
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn-success { background: var(--success); }
    .btn-warning { background: var(--warning); }
    .btn-danger { background: var(--danger); }
    .btn-secondary { background: var(--text-muted); }
    .btn-info { background: var(--info); }
    
    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 16px 0;
    }
    
    pre { 
      background: var(--light); 
      border: 1px solid var(--border);
      padding: 16px; 
      border-radius: 8px; 
      overflow-x: auto; 
      max-height: 300px; 
      font-size: 12px;
      font-family: 'Fira Code', monospace;
      line-height: 1.4;
      margin: 16px 0;
      position: relative;
    }
    
    [data-theme="dark"] pre {
      background: var(--dark);
      color: #e9ecef;
    }
    
    .copy-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(0,0,0,0.1);
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: var(--transition);
    }
    
    .copy-btn:hover {
      background: rgba(0,0,0,0.2);
    }
    
    .info-box { 
      background: var(--light); 
      border: 1px solid var(--border);
      padding: 16px; 
      border-radius: 8px; 
      margin: 16px 0;
      position: relative;
      border-left: 4px solid var(--primary);
    }
    
    .info-box.success { border-left-color: var(--success); background: rgba(39, 174, 96, 0.1); }
    .info-box.warning { border-left-color: var(--warning); background: rgba(243, 156, 18, 0.1); }
    .info-box.danger { border-left-color: var(--danger); background: rgba(231, 76, 60, 0.1); }
    
    .info-box h3 { 
      margin-top: 0; 
      color: var(--text); 
      font-size: 14px; 
      font-weight: 600;
    }
    
    .info-box p { 
      margin: 6px 0; 
      font-size: 13px; 
      color: var(--text-muted);
    }
    
    .preview-section { 
      margin-top: 20px; 
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }
    
    .preview-header {
      background: var(--light);
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      font-weight: 500;
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .preview-content {
      padding: 16px;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .file-drop-zone {
      border: 2px dashed var(--border);
      border-radius: 8px;
      padding: 32px;
      text-align: center;
      transition: var(--transition);
      cursor: pointer;
      background: var(--light);
      margin: 16px 0;
    }
    
    .file-drop-zone:hover {
      border-color: var(--primary);
      background: rgba(52, 152, 219, 0.05);
    }
    
    .file-drop-zone.dragover {
      border-color: var(--primary);
      background: rgba(52, 152, 219, 0.1);
      transform: scale(1.02);
    }
    
    .file-icon {
      font-size: 3rem;
      color: var(--text-muted);
      margin-bottom: 16px;
      display: block;
    }
    
    .progress-bar {
      width: 100%;
      height: 6px;
      background: var(--border);
      border-radius: 3px;
      overflow: hidden;
      margin: 16px 0;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--success));
      width: 0%;
      transition: width 0.3s ease;
    }
    
    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .status-success { background: rgba(39, 174, 96, 0.1); color: var(--success); }
    .status-warning { background: rgba(243, 156, 18, 0.1); color: var(--warning); }
    .status-danger { background: rgba(231, 76, 60, 0.1); color: var(--danger); }
    
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid var(--border);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .slide-in {
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .fade-in {
      animation: fadeIn 0.3s ease-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .collapsible-header {
      cursor: pointer;
      user-select: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      background: var(--light);
      border-radius: 8px;
      margin-bottom: 8px;
      transition: var(--transition);
    }
    
    .collapsible-header:hover {
      background: var(--border);
    }
    
    .collapsible-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    
    .collapsible-content.open {
      max-height: 2000px;
    }
    
    .chevron {
      transition: transform 0.3s ease;
    }
    
    .chevron.open {
      transform: rotate(180deg);
    }
    
    .tooltip {
      position: relative;
      cursor: help;
    }
    
    .tooltip::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--dark);
      color: white;
      padding: 6px 8px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
      z-index: 1000;
    }
    
    .tooltip:hover::after {
      opacity: 1;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin: 20px 0;
    }
    
    .stat-card {
      background: var(--card);
      padding: 20px;
      border-radius: 8px;
      border: 1px solid var(--border);
      text-align: center;
      transition: var(--transition);
    }
    
    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }
    
    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary);
      display: block;
    }
    
    .stat-label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 4px;
    }
    
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px 20px;
      box-shadow: var(--shadow-hover);
      z-index: 1000;
      max-width: 400px;
      transform: translateX(100%);
      transition: transform 0.3s ease;
    }
    
    .toast.show {
      transform: translateX(0);
    }
    
    .toast.success {
      border-left: 4px solid var(--success);
      background: rgba(39, 174, 96, 0.05);
    }
    
    .toast.error {
      border-left: 4px solid var(--danger);
      background: rgba(231, 76, 60, 0.05);
    }
    
    .toast.warning {
      border-left: 4px solid var(--warning);
      background: rgba(243, 156, 18, 0.05);
    }
    
    .toast.info {
      border-left: 4px solid var(--info);
      background: rgba(23, 162, 184, 0.05);
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <h1>🚀 API POS SalesHourly v2.5 Testing Dashboard</h1>
      <button class="theme-toggle" onclick="toggleTheme()">
        <span id="themeIcon">🌙</span>
        <span id="themeText">Dark Mode</span>
      </button>
    </div>
  </div>

  <div class="container">
    <!-- Toast Notification -->
    <div id="toast" class="toast" style="display: none;"></div>

    <div class="card slide-in">
      <h2 data-icon="🔐">OAuth2 Token Authentication</h2>
      <div class="grid-2">
        <div class="form-group">
          <label for="username">Tên người dùng <span class="required">*</span></label>
          <input type="text" id="username" value="postestuservn" required>
        </div>
        <div class="form-group">
          <label for="password">Mật khẩu <span class="required">*</span></label>
          <input type="password" id="password" value="@APITest1234" required>
        </div>
      </div>
      
      <div class="btn-group">
        <button id="btnToken" class="btn btn-primary">
          <span class="loading" id="tokenLoading" style="display: none;"></span>
          🔑 Lấy Token
        </button>
      </div>
      
      <div class="form-group">
        <label for="token">Token truy cập</label>
        <input type="text" id="token" readonly placeholder="Token sẽ xuất hiện tại đây">
        <div class="progress-bar" id="tokenProgress" style="display: none;">
          <div class="progress-fill"></div>
        </div>
      </div>
      
      <div class="collapsible-header" onclick="toggleCollapsible('tokenResponse')">
        <span>🔍 Phản hồi thô / Lỗi</span>
        <span class="chevron" id="tokenResponseChevron">▼</span>
      </div>
      <div class="collapsible-content" id="tokenResponseContent">
        <pre id="tokenResponse">
          <button class="copy-btn" onclick="copyToClipboard('tokenResponse')">📋 Copy</button>
        </pre>
      </div>
    </div>

    <div class="card slide-in">
      <h2 data-icon="⚙️">Cấu hình thông tin mặc định</h2>
      <div class="info-box warning">
        <h3>💡 Payment Methods Logic</h3>
        <p><strong>Payment Methods:</strong> Nhập số tiền thực tế cho từng phương thức thanh toán. 
        Nếu tất cả = 0, toàn bộ doanh thu sau chiết khấu sẽ được gán vào Cash. 
        Tổng các payment methods không được vượt quá (GTO - Discount). GST rate cố định 7%.</p>
      </div>
      <div class="grid-2">
        <div>
          <div class="form-group">
            <label for="machineId">Machine ID <span class="required">*</span></label>
            <input type="text" id="machineId" value="50100904" required class="tooltip" data-tooltip="Unique identifier for POS machine">
          </div>
          
          <div class="form-group">
            <label for="batchId">Batch ID (ZReport closing number) <span class="required">*</span></label>
            <input type="text" id="batchId" value="1" required class="tooltip" data-tooltip="ZReport closing sequence number">
          </div>
          
          <div class="form-group">
            <label for="reportDate">Ngày báo cáo <span class="required">*</span></label>
            <input type="date" id="reportDate" required>
          </div>
          
          <div class="form-group">
            <label for="receiptCount">Receipt Count (mặc định)</label>
            <input type="number" id="receiptCount" value="10" min="0" class="tooltip" data-tooltip="Default number of receipts per hour">
          </div>
          
          <div class="form-group">
            <label for="vatPercent">GST % (mặc định) <span class="required">*</span></label>
            <input type="number" id="vatPercent" value="7" step="0.1" min="0" max="100" required class="tooltip" data-tooltip="Fixed GST rate at 7%">
          </div>
          
          <div class="form-group">
            <label for="serviceCharge">Service Charge (F&B only)</label>
            <input type="number" id="serviceCharge" value="0" step="0.01" min="0">
          </div>
          
          <div class="form-group">
            <label for="noofpax">Number of Pax (F&B only)</label>
            <input type="number" id="noofpax" value="0" min="0">
          </div>
        </div>
        
        <div>
          <label for="cash">Cash (after discount, before GST)</label>
          <input type="number" id="cash" value="0" step="0.01" min="0" placeholder="0 = auto assign all">
          
          <label for="atm">ATM (after discount, before GST)</label>
          <input type="number" id="atm" value="0" step="0.01" min="0">
          
          <label for="visa">Visa (after discount, before GST)</label>
          <input type="number" id="visa" value="0" step="0.01" min="0">
          
          <label for="mastercard">Mastercard (after discount, before GST)</label>
          <input type="number" id="mastercard" value="0" step="0.01" min="0">
          
          <label for="amex">Amex (after discount, before GST)</label>
          <input type="number" id="amex" value="0" step="0.01" min="0">
          
          <label for="voucher">Voucher (after discount, before GST)</label>
          <input type="number" id="voucher" value="0" step="0.01" min="0">
          
          <label for="vatRegistered">VAT Registered <span style="color: red;">*</span></label>
          <select id="vatRegistered" required>
            <option value="Y">Yes (Y)</option>
            <option value="N" selected>No (N)</option>
          </select>
        </div>
      </div>
      
      <div class="btn-group">
        <button type="button" onclick="resetForm()" class="btn btn-secondary">🔄 Reset Form</button>
        <button type="button" onclick="validateAndShowPreview()" class="btn btn-success">✓ Validate Form</button>
        <button type="button" onclick="generateEmpty24Hours()" class="btn btn-warning">⏰ Generate 24 Hours (Empty)</button>
      </div>
      
      <div style="margin-top: 12px; padding: 10px; background: #e8f5e8; border-radius: 4px; font-size: 13px;">
        <strong>📋 Logic tính toán:</strong><br>
        • <strong>GTO:</strong> Tổng doanh thu từ file Excel<br>
        • <strong>GST:</strong> (GTO - Discount) × 7% (fixed rate)<br>
        • <strong>Payment Methods:</strong> Nếu tất cả = 0, toàn bộ net amount sẽ vào Cash. Nếu có giá trị, sử dụng số tiền đã cấu hình<br>
        • <strong>Others Amount:</strong> Phần còn lại = (GTO - Discount) - tổng payment methods<br>
        • <strong>⚠️ API yêu cầu đủ 24 records (hour 00-23) cho mỗi ngày!</strong>
      </div>
      
      <!-- Thêm example payload -->
      <details style="margin-top: 12px;">
        <summary style="cursor: pointer; font-weight: 500; color: var(--secondary);">📖 Xem example payload đúng format (theo API response)</summary>
        <pre style="margin-top: 8px; font-size: 11px; background: #f8f9fa; border: 1px solid #e9ecef;">
{
  "sales": [
    {
      "sale": {
        "machineid": "50100904",
        "batchid": "1",
        "date": "20220125",              // yyyyMMdd format
        "hour": "01",                   // HH format (24 hour)
        "receiptcount": "5",            // Số giao dịch trong giờ
        "gto": "191.54",               // Tổng doanh thu từ Excel
        "gst": "13.41",                // (gto - discount) × 7%
        "discount": "0.00",            // Chiết khấu từ Excel
        "servicecharge": "5.00",       // F&B only
        "noofpax": "0",               // F&B only
        "cash": "172.39",             // After discount, before GST
        "atm": "0.00",                // After discount, before GST
        "visa": "0.00",               // After discount, before GST
        "mastercard": "0.00",         // After discount, before GST
        "amex": "0.00",               // After discount, before GST
        "voucher": "0.00",            // After discount, before GST
        "othersamount": "0.00",       // Phần còn lại
        "vatregistered": "N"          // lowercase
      }
    }
  ]
}

⚠️ Lỗi thường gặp:
{
  "status": "error",
  "errors": [
    {
      "status_code": "Daily records",
      "message": "ERROR: Every day should have 24 Records. Hour 00 to 23. Date :20220125"
    }
  ]
}

Giải thích tính toán:
• gto: 191.54 (từ Excel)
• discount: 0.00 (từ Excel)  
• Net amount: 191.54 - 0.00 = 191.54
• gst: 191.54 × 7% = 13.41 (fixed 7%)
• cash: 191.54 (vì tất cả payment = 0)
• othersamount: 191.54 - 191.54 = 0.00
        </pre>
      </details>
    </div>

    <div class="card slide-in">
      <h2 data-icon="✏️">Manual Entry Management</h2>
      <div class="info-box danger">
        <h3>⚠️ 24 Hours Requirement</h3>
        <p>Thêm/sửa entries thủ công để đảm bảo có đủ 24 records (hour 00-23). API yêu cầu strict 24 hours data.</p>
      </div>
      
      <div class="btn-group">
        <button type="button" onclick="addManualEntry()" class="btn btn-info">➕ Add Manual Entry</button>
        <button type="button" onclick="validatePayload()" class="btn btn-danger">🔍 Validate Payload (Check 24 Hours)</button>
        <button type="button" onclick="fillMissingHours()" class="btn btn-warning">⚡ Auto Fill Missing Hours</button>
        <button type="button" onclick="sortPayloadByHour()" class="btn btn-secondary">🔢 Sort by Hour</button>
      </div>
      
      <div id="manualEntryForm" style="display:none; background: #f8f9fa; padding: 16px; border-radius: 4px; margin-bottom: 16px;">
        <h3 style="margin-top: 0;">Add/Edit Entry</h3>
        <div class="grid-2">
          <div>
            <label for="entryHour">Hour (00-23) <span style="color: red;">*</span></label>
            <select id="entryHour">
              <option value="">Select Hour</option>
            </select>
            
            <label for="entryReceiptCount">Receipt Count</label>
            <input type="number" id="entryReceiptCount" value="0" min="0">
            
            <label for="entryGTO">GTO</label>
            <input type="number" id="entryGTO" value="0" step="0.01" min="0">
            
            <label for="entryDiscount">Discount</label>
            <input type="number" id="entryDiscount" value="0" step="0.01" min="0">
          </div>
          <div>
            <label for="entryCash">Cash</label>
            <input type="number" id="entryCash" value="0" step="0.01" min="0">
            
            <label for="entryATM">ATM</label>
            <input type="number" id="entryATM" value="0" step="0.01" min="0">
            
            <label for="entryVisa">Visa</label>
            <input type="number" id="entryVisa" value="0" step="0.01" min="0">
            
            <label for="entryOthers">Others Amount</label>
            <input type="number" id="entryOthers" value="0" step="0.01" min="0">
          </div>
        </div>
        
        <div style="margin-top: 12px;">
          <button type="button" onclick="saveManualEntry()" style="background: #27ae60;">💾 Save Entry</button>
          <button type="button" onclick="cancelManualEntry()" style="background: #95a5a6;">❌ Cancel</button>
        </div>
      </div>
      
      <div id="validationResult" style="display:none; padding: 12px; border-radius: 4px; margin-bottom: 16px;">
      </div>
    </div>

    <div class="card slide-in">
      <h2 data-icon="📁">Upload và xử lý file</h2>
      
      <div class="file-drop-zone" id="fileDropZone" onclick="document.getElementById('fileInput').click()">
        <div class="file-icon">📄</div>
        <p><strong>Kéo thả file vào đây hoặc click để chọn</strong></p>
        <p style="color: var(--text-muted); font-size: 12px;">Hỗ trợ: .csv, .xls, .xlsx (Max: 10MB)</p>
        <input type="file" id="fileInput" accept=".csv, .xls, .xlsx" style="display: none;">
      </div>
      
      <!-- Thêm khu vực hiển thị thông tin file -->
      <div id="fileInfo" class="info-box" style="display:none;">
        <h3>Thông tin file:</h3>
        <p id="fileName"></p>
        <p id="fileSize"></p>
        <p id="recordCount"></p>
      </div>
      
      <!-- Thêm khu vực preview dữ liệu -->
      <div id="dataPreview" class="preview-section" style="display:none;">
        <h3>Preview dữ liệu gốc (5 dòng đầu):</h3>
        <pre id="rawDataPreview" style="max-height: 150px; overflow-y: auto;"></pre>
        
        <h3>Preview dữ liệu đã xử lý (5 giờ đầu):</h3>
        <pre id="processedDataPreview" style="max-height: 150px; overflow-y: auto;"></pre>
      </div>
      
      <div class="form-group">
        <label for="salesData">Dữ liệu SalesHourly (JSON Payload)</label>
        <textarea id="salesData">{"sales":[]}</textarea>
        <div class="btn-group">
          <button id="btnSales" class="btn btn-primary">
            <span class="loading" id="salesLoading" style="display: none;"></span>
            🚀 Gửi SalesHourly
          </button>
          <button onclick="copyToClipboard('salesData')" class="btn btn-secondary">📋 Copy Payload</button>
          <button onclick="validateJSON()" class="btn btn-info">✓ Validate JSON</button>
        </div>
      </div>
      
      <div class="collapsible-header" onclick="toggleCollapsible('salesResponse')">
        <span>🔍 Phản hồi API / Lỗi</span>
        <span class="chevron" id="salesResponseChevron">▼</span>
      </div>
      <div class="collapsible-content" id="salesResponseContent">
        <pre id="salesResponse">
          <button class="copy-btn" onclick="copyToClipboard('salesResponse')">📋 Copy</button>
        </pre>
      </div>
    </div>
  </div>

  <script>
    const baseUrl = 'https://staging.synthesis.bz/posvn/v1/api';

    document.getElementById('btnToken').addEventListener('click', async () => {
      const user = document.getElementById('username').value.trim();
      const pass = document.getElementById('password').value.trim();
      
      if (!user || !pass) {
        showToast('Vui lòng nhập đầy đủ username và password!', 'warning');
        return;
      }
      
      setButtonLoading('btnToken', true);
      animateProgressBar('tokenProgress', 100, 2000);
      
      try {
        const res = await fetch(`${baseUrl}/token`, {
          method: 'POST', 
          headers: {'Content-Type':'application/x-www-form-urlencoded'},
          body: `grant_type=password&username=${encodeURIComponent(user)}&password=${encodeURIComponent(pass)}`, 
          mode: 'cors'
        }); 
        
        if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
        
        const data = await res.json();
        document.getElementById('tokenResponse').textContent = JSON.stringify(data,null,2);
        document.getElementById('token').value = data.access_token||'';
        
        if (data.access_token) {
          showToast('Token lấy thành công! 🎉', 'success');
        } else {
          showToast('Không nhận được token từ API', 'warning');
        }
        
      } catch(err) {
        document.getElementById('tokenResponse').textContent = 'Lỗi: '+err.message;
        showToast(`Lỗi khi lấy token: ${err.message}`, 'error');
      } finally {
        setButtonLoading('btnToken', false);
      }
    });

    function parseCSV(text) {
      const lines = text.trim().split(/\r?\n/);
      const headers = lines.shift().split(/,|;|\t/).map(h=>h.trim());
      return lines.map(line=>{
        const cols = line.split(/,|;|\t/).map(c=>c.trim());
        const obj = {}; headers.forEach((h,i)=>obj[h]=isNaN(cols[i])?cols[i]:Number(cols[i])); return obj;
      });
    }

    function transformToHourly(raw) {
      const date = document.getElementById('reportDate').value;
      const machineid = document.getElementById('machineId').value.trim();
      const batchid = document.getElementById('batchId').value.trim();
      const receiptCountDefault = Number(document.getElementById('receiptCount').value);
      const vatPercent = Number(document.getElementById('vatPercent').value);
      const serviceChargeDefault = Number(document.getElementById('serviceCharge').value);
      const noofpaxDefault = Number(document.getElementById('noofpax').value);
      const cashDefault = Number(document.getElementById('cash').value);
      const atmDefault = Number(document.getElementById('atm').value);
      const visaDefault = Number(document.getElementById('visa').value);
      const mastercardDefault = Number(document.getElementById('mastercard').value);
      const amexDefault = Number(document.getElementById('amex').value);
      const voucherDefault = Number(document.getElementById('voucher').value);
      const vatRegistered = document.getElementById('vatRegistered').value;
      
      // Thử nhiều format date khác nhau
      function formatDateForAPI(dateStr) {
        if (!dateStr) return '';
        
        // Format theo document: yyyyMMdd (VD: "20220125")
        const dateObj = new Date(dateStr);
        if (isNaN(dateObj.getTime())) return dateStr;
        
        const year = dateObj.getFullYear();
        const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
        const day = dateObj.getDate().toString().padStart(2, '0');
        
        // Format yyyyMMdd theo document
        const yyyymmdd = `${year}${month}${day}`;
        console.log(`Date conversion: ${dateStr} -> ${yyyymmdd}`);
        
        return yyyymmdd;
      }
      
      const formattedDate = formatDateForAPI(date);
      
      // Khởi tạo dữ liệu cho 24 giờ
      const hourlyData = {};
      for (let i = 0; i < 24; i++) {
        hourlyData[i.toString().padStart(2, '0')] = {
          receiptcount: 0,
          gto: 0, // gross turnover (tổng doanh thu)
          discount: 0,
          sales: [], // lưu danh sách các sale để tính toán
        };
      }
      
      // Tìm cột thời gian với nhiều pattern khác nhau
      const timeKey = Object.keys(raw[0]||{}).find(k => 
        /thời\s*gian|time|ngày|date|datetime|timestamp|created|order_time/i.test(k)
      );
      
      console.log('Raw data sample:', raw.slice(0, 3));
      console.log('Time key found:', timeKey);
      
      raw.forEach((order, index) => {
        // Xử lý nhiều cách tìm cột tổng tiền
        const sale = Number(
          order['Tổng tiền'] || 
          order['Total'] || 
          order['Amount'] || 
          order['Subtotal'] || 
          order['__EMPTY_8'] || 
          order['Doanh thu'] ||
          order['Revenue'] ||
          0
        );
        
        // Xử lý nhiều cách tìm cột chiết khấu
        const discount = Number(
          order['CK đơn hàng(VNĐ)'] || 
          order['Discount'] || 
          order['Chiết khấu'] || 
          order['__EMPTY_9'] || 
          order['Giảm giá'] ||
          0
        );
        
        // Xử lý thời gian thông minh hơn
        let hour = '00';
        if (timeKey && order[timeKey]) {
          const timeStr = order[timeKey].toString();
          
          // Thử parse theo nhiều format khác nhau
          let dateObj = null;
          
          // Format: DD/MM/YYYY HH:mm:ss
          if (timeStr.match(/\d{1,2}\/\d{1,2}\/\d{4}\s+\d{1,2}:\d{2}/)) {
            const parts = timeStr.split(' ');
            const datePart = parts[0].split('/');
            const timePart = parts[1] || '00:00';
            dateObj = new Date(`${datePart[2]}-${datePart[1].padStart(2,'0')}-${datePart[0].padStart(2,'0')}T${timePart}`);
          }
          // Format: YYYY-MM-DD HH:mm:ss
          else if (timeStr.match(/\d{4}-\d{1,2}-\d{1,2}/)) {
            dateObj = new Date(timeStr);
          }
          // Format: chỉ có giờ HH:mm
          else if (timeStr.match(/^\d{1,2}:\d{2}/)) {
            const today = new Date();
            dateObj = new Date(`${today.getFullYear()}-${(today.getMonth()+1).toString().padStart(2,'0')}-${today.getDate().toString().padStart(2,'0')}T${timeStr}`);
          }
          // Thử parse trực tiếp
          else {
            dateObj = new Date(timeStr);
          }
          
          // Kiểm tra ngày hợp lệ
          if (dateObj && !isNaN(dateObj.getTime())) {
            const hourNum = dateObj.getHours();
            if (hourNum >= 0 && hourNum <= 23) {
              hour = hourNum.toString().padStart(2, '0');
            }
          } else {
            console.warn(`Cannot parse time: ${timeStr} at row ${index + 1}`);
          }
        }
        
        // Cộng dồn dữ liệu vào giờ tương ứng
        if (sale > 0 || discount > 0) {
          hourlyData[hour].receiptcount += 1;
          hourlyData[hour].gto += sale;
          hourlyData[hour].discount += discount;
          hourlyData[hour].sales.push({ sale, discount });
        }
        
        if (index < 5) { // Log một vài dòng đầu để debug
          console.log(`Row ${index + 1}: Time=${order[timeKey]}, Hour=${hour}, Sale=${sale}, Discount=${discount}`);
        }
      });
      
      // Tạo payload theo format API SalesHourly
      const salesArray = [];
      
      // Đảm bảo tạo đủ 24 giờ (00-23) để tránh lỗi "Daily records"
      for (let i = 0; i < 24; i++) {
        const hour = i.toString().padStart(2, '0');
        const data = hourlyData[hour];
        
        const netSale = data.gto - data.discount; // after discount, before GST
        const gstAmount = (netSale * vatPercent / 100);
        
        // Payment methods phải là "after discount and before GST"
        let actualCash = cashDefault;
        let actualATM = atmDefault;
        let actualVisa = visaDefault;
        let actualMastercard = mastercardDefault;
        let actualAmex = amexDefault;
        let actualVoucher = voucherDefault;
        
        // Nếu tất cả payment methods đều = 0, phân bổ toàn bộ netSale vào cash
        const totalPaymentDefaults = cashDefault + atmDefault + visaDefault + mastercardDefault + amexDefault + voucherDefault;
        
        if (totalPaymentDefaults === 0) {
          // Phân bổ toàn bộ netSale vào cash nếu không có cấu hình payment methods
          actualCash = netSale;
          actualATM = 0;
          actualVisa = 0;
          actualMastercard = 0;
          actualAmex = 0;
          actualVoucher = 0;
        } else {
          // Sử dụng giá trị đã cấu hình (nhưng không vượt quá netSale)
          const totalConfigured = totalPaymentDefaults;
          if (totalConfigured > netSale) {
            // Nếu tổng cấu hình > netSale, scale down theo tỷ lệ
            const scale = netSale / totalConfigured;
            actualCash = cashDefault * scale;
            actualATM = atmDefault * scale;
            actualVisa = visaDefault * scale;
            actualMastercard = mastercardDefault * scale;
            actualAmex = amexDefault * scale;
            actualVoucher = voucherDefault * scale;
          }
          // Nếu totalConfigured <= netSale, giữ nguyên giá trị cấu hình
        }
        
        // Tính othersamount (phần còn lại)
        const totalKnownPayments = actualCash + actualATM + actualVisa + actualMastercard + actualAmex + actualVoucher;
        const othersamount = Math.max(0, netSale - totalKnownPayments);
        
        salesArray.push({
          sale: {
            machineid: machineid,
            batchid: batchid,
            date: formattedDate, // Sử dụng date đã được format
            hour: hour,
            receiptcount: data.receiptcount.toString(),
            gto: data.gto.toFixed(2),
            gst: gstAmount.toFixed(2),                // Field name: gst
            discount: data.discount.toFixed(2),
            servicecharge: serviceChargeDefault.toFixed(2),
            noofpax: noofpaxDefault.toString(),
            cash: actualCash.toFixed(2),              // after discount, before GST
            atm: actualATM.toFixed(2),               // Field name: atm (lowercase)
            visa: actualVisa.toFixed(2),             // after discount, before GST
            mastercard: actualMastercard.toFixed(2), // after discount, before GST
            amex: actualAmex.toFixed(2),             // after discount, before GST
            voucher: actualVoucher.toFixed(2),       // after discount, before GST
            othersamount: othersamount.toFixed(2),   // after discount, before GST
            vatregistered: vatRegistered              // Field name: vatregistered (lowercase)
          }
        });
      }
      
      console.log(`Generated ${salesArray.length} entries for 24 hours`);
      console.log('First 3 entries:', salesArray.slice(0, 3));
      
      return {
        sales: salesArray
      };
    }

    document.getElementById('fileInput').addEventListener('change', e=>{
      const file = e.target.files[0]; 
      if(!file) {
        document.getElementById('fileInfo').style.display = 'none';
        document.getElementById('dataPreview').style.display = 'none';
        return;
      }
      
      // Hiển thị thông tin file
      document.getElementById('fileName').textContent = `Tên file: ${file.name}`;
      document.getElementById('fileSize').textContent = `Kích thước: ${(file.size / 1024).toFixed(2)} KB`;
      document.getElementById('fileInfo').style.display = 'block';
      
      const reader = new FileReader(); 
      reader.onload = evt => {
        try {
          let arr = file.name.endsWith('.csv') ? parseCSV(evt.target.result)
            : XLSX.utils.sheet_to_json(XLSX.read(evt.target.result,{type:'binary'}).Sheets[XLSX.read(evt.target.result,{type:'binary'}).SheetNames[0]],{raw:false});
          
          // Cập nhật số lượng record
          document.getElementById('recordCount').textContent = `Số dòng dữ liệu: ${arr.length}`;
          
          // Hiển thị preview dữ liệu gốc
          document.getElementById('rawDataPreview').textContent = JSON.stringify(arr.slice(0, 5), null, 2);
          
          // Transform dữ liệu
          const hourly = transformToHourly(arr);
          
          // Hiển thị preview dữ liệu đã xử lý (chỉ những giờ có dữ liệu)
          const salesData = hourly.sales.slice(0, 5);
          document.getElementById('processedDataPreview').textContent = JSON.stringify(salesData.length > 0 ? salesData : [{"message": "Không có dữ liệu sau khi xử lý"}], null, 2);
          
          // Hiển thị khu vực preview
          document.getElementById('dataPreview').style.display = 'block';
          
          // Cập nhật textarea với dữ liệu đã xử lý
          document.getElementById('salesData').value = JSON.stringify(hourly, null, 2);
          
        } catch (error) {
          console.error('Error processing file:', error);
          document.getElementById('salesResponse').textContent = `Lỗi xử lý file: ${error.message}`;
        }
      };
      
      if (file.name.endsWith('.csv')) {
        reader.readAsText(file);
      } else {
        reader.readAsBinaryString(file);
      }
    });

    document.getElementById('btnSales').addEventListener('click', async ()=>{
      const token = document.getElementById('token').value.trim();
      
      if (!token) {
        showToast('Vui lòng lấy token trước khi gửi dữ liệu!', 'warning');
        return;
      }
      
      const payload = document.getElementById('salesData').value;
      
      // Validate JSON first
      try {
        JSON.parse(payload);
      } catch (error) {
        showToast(`JSON payload không hợp lệ: ${error.message}`, 'error');
        return;
      }
      
      setButtonLoading('btnSales', true);
      
      try {
        console.log('Sending payload:', payload);
        
        const res = await fetch(`${baseUrl}/SalesHourly`,{
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'Authorization':'Bearer '+token
          },
          body: payload,
          mode:'cors'
        }); 
        
        const responseData = await res.json();
        
        if(!res.ok) {
          // API returned error
          if (responseData.errors && responseData.errors.length > 0) {
            const errorMessage = responseData.errors[0].message;
            const statusCode = responseData.errors[0].status_code;
            
            if (statusCode === 'Daily records') {
              showToast('Lỗi Daily Records! Thiếu entries cho một số giờ.', 'error');
              document.getElementById('salesResponse').innerHTML = 
                `❌ <strong>Lỗi Daily Records!</strong>\n\n` +
                `${errorMessage}\n\n` +
                `🔧 <strong>Cách khắc phục:</strong>\n` +
                `1. Nhấn nút "🔍 Validate Payload" để kiểm tra\n` +
                `2. Nhấn nút "⚡ Auto Fill Missing Hours" để tự động thêm giờ thiếu\n` +
                `3. Hoặc dùng "➕ Add Manual Entry" để thêm từng giờ thủ công\n\n` +
                `📋 <strong>Full response:</strong>\n` +
                JSON.stringify(responseData, null, 2);
            } else {
              showToast(`API Error: ${statusCode}`, 'error');
              document.getElementById('salesResponse').textContent = 
                `❌ API Error: ${statusCode}\n${errorMessage}\n\nFull response:\n` +
                JSON.stringify(responseData, null, 2);
            }
          } else {
            throw new Error(`${res.status} ${res.statusText}`);
          }
        } else {
          // Success
          showToast('SalesHourly API call thành công! 🎉', 'success');
          document.getElementById('salesResponse').textContent = 
            `✅ Thành công!\n\n` +
            JSON.stringify(responseData, null, 2);
        }
        
      } catch(err) {
        showToast(`Network/Connection Error: ${err.message}`, 'error');
        document.getElementById('salesResponse').textContent = 
          `❌ Network/Connection Error: ${err.message}\n\n` +
          `Có thể do:\n` +
          `- Mất kết nối internet\n` +
          `- Token hết hạn\n` +
          `- Server không phản hồi\n` +
          `- CORS policy`;
        console.error('API call failed:', err);
      } finally {
        setButtonLoading('btnSales', false);
      }
    });

    // Thêm các hàm helper
    function resetForm() {
      document.getElementById('machineId').value = '50100904';
      document.getElementById('batchId').value = '1';
      document.getElementById('reportDate').value = '';
      document.getElementById('receiptCount').value = '10';
      document.getElementById('vatPercent').value = '7';
      document.getElementById('serviceCharge').value = '0';
      document.getElementById('noofpax').value = '0';
      document.getElementById('cash').value = '0';
      document.getElementById('atm').value = '0';
      document.getElementById('visa').value = '0';
      document.getElementById('mastercard').value = '0';
      document.getElementById('amex').value = '0';
      document.getElementById('voucher').value = '0';
      document.getElementById('vatRegistered').value = 'N';
      
      // Clear file input và previews
      document.getElementById('fileInput').value = '';
      document.getElementById('fileInfo').style.display = 'none';
      document.getElementById('dataPreview').style.display = 'none';
      document.getElementById('salesData').value = '{"sales":[]}';
      document.getElementById('salesResponse').textContent = '';
      
      console.log('Form đã được reset');
    }

    function validateAndShowPreview() {
      const requiredFields = [
        {id: 'machineId', name: 'Machine ID'},
        {id: 'batchId', name: 'Batch ID'},
        {id: 'reportDate', name: 'Ngày báo cáo'},
        {id: 'vatPercent', name: 'VAT %'}
      ];
      
      let isValid = true;
      let errors = [];
      
      requiredFields.forEach(field => {
        const element = document.getElementById(field.id);
        const value = element.value.trim();
        
        if (!value) {
          isValid = false;
          errors.push(`${field.name} là bắt buộc`);
          element.style.borderColor = '#e74c3c';
        } else {
          element.style.borderColor = '#bdc3c7';
        }
      });
      
      // Validate VAT percentage
      const vatPercent = Number(document.getElementById('vatPercent').value);
      if (vatPercent < 0 || vatPercent > 100) {
        isValid = false;
        errors.push('GST % phải từ 0 đến 100');
        document.getElementById('vatPercent').style.borderColor = '#e74c3c';
      }
      
      if (isValid) {
        alert('✅ Form hợp lệ! Bạn có thể upload file để xử lý dữ liệu.');
        console.log('Form validation passed');
      } else {
        alert('❌ Có lỗi trong form:\n' + errors.join('\n'));
        console.log('Form validation errors:', errors);
      }
      
      return isValid;
    }
    
    function generateEmpty24Hours() {
      const machineId = document.getElementById('machineId').value.trim();
      const batchId = document.getElementById('batchId').value.trim();
      const reportDate = document.getElementById('reportDate').value;
      const serviceCharge = document.getElementById('serviceCharge').value;
      const noofpax = document.getElementById('noofpax').value;
      const vatRegistered = document.getElementById('vatRegistered').value;
      
      if (!machineId || !batchId || !reportDate) {
        alert('Vui lòng điền đầy đủ Machine ID, Batch ID và Ngày báo cáo trước!');
        return;
      }
      
      // Format date to yyyyMMdd
      function formatDateForAPI(dateStr) {
        const dateObj = new Date(dateStr);
        if (isNaN(dateObj.getTime())) return dateStr;
        
        const year = dateObj.getFullYear();
        const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
        const day = dateObj.getDate().toString().padStart(2, '0');
        
        return `${year}${month}${day}`;
      }
      
      const formattedDate = formatDateForAPI(reportDate);
      const salesArray = [];
      
      // Generate 24 empty entries
      for (let i = 0; i < 24; i++) {
        const hour = i.toString().padStart(2, '0');
        
        salesArray.push({
          sale: {
            machineid: machineId,
            batchid: batchId,
            date: formattedDate,
            hour: hour,
            receiptcount: "0",
            gto: "0.00",
            gst: "0.00",
            discount: "0.00",
            servicecharge: serviceCharge,
            noofpax: noofpax,
            cash: "0.00",
            atm: "0.00",
            visa: "0.00",
            mastercard: "0.00",
            amex: "0.00",
            voucher: "0.00",
            othersamount: "0.00",
            vatregistered: vatRegistered
          }
        });
      }
      
      const payload = { sales: salesArray };
      document.getElementById('salesData').value = JSON.stringify(payload, null, 2);
      
      alert(`✅ Đã tạo 24 entries trống cho ngày ${formattedDate}. Bạn có thể chỉnh sửa từng entry thủ công.`);
      console.log('Generated 24 empty hours data');
    }

    // Auto-set ngày hiện tại khi trang load
    window.addEventListener('load', () => {
      if (!document.getElementById('reportDate').value) {
        document.getElementById('reportDate').value = new Date().toISOString().slice(0,10);
      }
    });
    
    // Theme Toggle
    function toggleTheme() {
      const body = document.body;
      const themeIcon = document.getElementById('themeIcon');
      const themeText = document.getElementById('themeText');
      
      if (body.getAttribute('data-theme') === 'dark') {
        body.removeAttribute('data-theme');
        themeIcon.textContent = '🌙';
        themeText.textContent = 'Dark Mode';
        localStorage.setItem('theme', 'light');
      } else {
        body.setAttribute('data-theme', 'dark');
        themeIcon.textContent = '☀️';
        themeText.textContent = 'Light Mode';
        localStorage.setItem('theme', 'dark');
      }
    }
    
    // Load saved theme
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
      document.body.setAttribute('data-theme', 'dark');
      document.getElementById('themeIcon').textContent = '☀️';
      document.getElementById('themeText').textContent = 'Light Mode';
    }
    
    // Toast Notifications
    function showToast(message, type = 'info', duration = 5000) {
      const toast = document.getElementById('toast');
      toast.className = `toast ${type}`;
      toast.innerHTML = `
        <div style="display: flex; align-items: center; gap: 8px;">
          <span style="font-size: 18px;">
            ${type === 'success' ? '✅' : type === 'error' ? '❌' : type === 'warning' ? '⚠️' : 'ℹ️'}
          </span>
          <span>${message}</span>
          <button onclick="hideToast()" style="background: none; border: none; font-size: 16px; cursor: pointer; margin-left: auto;">✕</button>
        </div>
      `;
      toast.style.display = 'block';
      
      setTimeout(() => {
        toast.classList.add('show');
      }, 100);
      
      setTimeout(() => {
        hideToast();
      }, duration);
    }
    
    function hideToast() {
      const toast = document.getElementById('toast');
      toast.classList.remove('show');
      setTimeout(() => {
        toast.style.display = 'none';
      }, 300);
    }
    
    // Collapsible Sections
    function toggleCollapsible(id) {
      const content = document.getElementById(id + 'Content');
      const chevron = document.getElementById(id + 'Chevron');
      
      if (content.classList.contains('open')) {
        content.classList.remove('open');
        chevron.textContent = '▼';
        chevron.classList.remove('open');
      } else {
        content.classList.add('open');
        chevron.textContent = '▲';
        chevron.classList.add('open');
      }
    }
    
    // Copy to Clipboard
    async function copyToClipboard(elementId) {
      const element = document.getElementById(elementId);
      let text = '';
      
      if (element.tagName === 'TEXTAREA' || element.tagName === 'INPUT') {
        text = element.value;
      } else {
        text = element.textContent;
      }
      
      try {
        await navigator.clipboard.writeText(text);
        showToast('Đã copy vào clipboard!', 'success', 2000);
      } catch (err) {
        console.error('Failed to copy: ', err);
        showToast('Không thể copy. Hãy copy thủ công.', 'error');
      }
    }
    
    // JSON Validation
    function validateJSON() {
      const salesData = document.getElementById('salesData').value;
      try {
        JSON.parse(salesData);
        showToast('JSON hợp lệ! ✓', 'success');
      } catch (error) {
        showToast(`JSON không hợp lệ: ${error.message}`, 'error');
      }
    }
    
    // Drag & Drop for file upload
    const fileDropZone = document.getElementById('fileDropZone');
    const fileInput = document.getElementById('fileInput');
    
    fileDropZone.addEventListener('dragover', (e) => {
        e.stopPropagation();
      e.preventDefault();
      fileDropZone.classList.add('dragover');
    });
    
    fileDropZone.addEventListener('dragleave', (e) => {
        e.stopPropagation();

      e.preventDefault();
      fileDropZone.classList.remove('dragover');
    });
    
    fileDropZone.addEventListener('drop', (e) => {
        e.stopPropagation();

      e.preventDefault();
      fileDropZone.classList.remove('dragover');
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        const file = files[0];
        if (file.name.match(/\.(csv|xls|xlsx)$/i)) {
          if (file.size <= 10 * 1024 * 1024) { // 10MB limit
            fileInput.files = files;
            fileInput.dispatchEvent(new Event('change'));
            showToast(`File "${file.name}" đã được chọn!`, 'success');
          } else {
            showToast('File quá lớn! Giới hạn 10MB.', 'error');
          }
        } else {
          showToast('File không được hỗ trợ! Chỉ chấp nhận .csv, .xls, .xlsx', 'error');
        }
      }
    });
    
    // Enhanced button loading states
    function setButtonLoading(buttonId, isLoading) {
      const button = document.getElementById(buttonId);
      const loadingSpinner = button.querySelector('.loading');
      
      if (isLoading) {
        button.disabled = true;
        if (loadingSpinner) loadingSpinner.style.display = 'inline-block';
      } else {
        button.disabled = false;
        if (loadingSpinner) loadingSpinner.style.display = 'none';
      }
    }
    
    // Progress bar animation
    function animateProgressBar(progressBarId, targetPercent, duration = 1000) {
      const progressBar = document.getElementById(progressBarId);
      const progressFill = progressBar.querySelector('.progress-fill');
      
      progressBar.style.display = 'block';
      progressFill.style.width = '0%';
      
      setTimeout(() => {
        progressFill.style.width = targetPercent + '%';
      }, 100);
      
      setTimeout(() => {
        progressBar.style.display = 'none';
      }, duration + 500);
    }
    
    // Replace alert with toast notifications
    window.alert = function(message) {
      if (message.includes('✅')) {
        showToast(message.replace('✅', ''), 'success');
      } else if (message.includes('❌')) {
        showToast(message.replace('❌', ''), 'error');
      } else if (message.includes('⚠️')) {
        showToast(message.replace('⚠️', ''), 'warning');
      } else {
        showToast(message, 'info');
      }
    };
    
    // Enhanced form validation with real-time feedback
    function addRealTimeValidation() {
      const inputs = document.querySelectorAll('input[required], select[required]');
      inputs.forEach(input => {
        input.addEventListener('blur', () => {
          if (input.validity.valid) {
            input.style.borderColor = 'var(--success)';
          } else {
            input.style.borderColor = 'var(--danger)';
          }
        });
        
        input.addEventListener('input', () => {
          if (input.style.borderColor === 'var(--danger)' && input.validity.valid) {
            input.style.borderColor = 'var(--success)';
          }
        });
      });
    }
    
    // Initialize real-time validation when page loads
    window.addEventListener('load', () => {
      addRealTimeValidation();
    });

    // Manual Entry Management
    function addManualEntry() {
      const form = document.getElementById('manualEntryForm');
      form.style.display = 'block';
      document.getElementById('entryHour').innerHTML = ''; // Clear previous options
      for (let i = 0; i < 24; i++) {
        const option = document.createElement('option');
        option.value = i.toString().padStart(2, '0');
        option.textContent = `Hour ${i.toString().padStart(2, '0')}`;
        document.getElementById('entryHour').appendChild(option);
      }
      document.getElementById('entryReceiptCount').value = '0';
      document.getElementById('entryGTO').value = '0';
      document.getElementById('entryDiscount').value = '0';
      document.getElementById('entryCash').value = '0';
      document.getElementById('entryATM').value = '0';
      document.getElementById('entryVisa').value = '0';
      document.getElementById('entryOthers').value = '0';
      document.getElementById('validationResult').style.display = 'none';
      document.getElementById('validationResult').textContent = '';
    }

    function cancelManualEntry() {
      document.getElementById('manualEntryForm').style.display = 'none';
    }

    function saveManualEntry() {
      const hour = document.getElementById('entryHour').value;
      const receiptCount = document.getElementById('entryReceiptCount').value;
      const gto = document.getElementById('entryGTO').value;
      const discount = document.getElementById('entryDiscount').value;
      const cash = document.getElementById('entryCash').value;
      const atm = document.getElementById('entryATM').value;
      const visa = document.getElementById('entryVisa').value;
      const others = document.getElementById('entryOthers').value;
      const vatRegistered = document.getElementById('vatRegistered').value;

      if (!hour) {
        alert('Vui lòng chọn giờ!');
        return;
      }
      
      // Format date to yyyyMMdd
      function formatDateForAPI(dateStr) {
        if (!dateStr) return '';
        const dateObj = new Date(dateStr);
        if (isNaN(dateObj.getTime())) return dateStr;
        
        const year = dateObj.getFullYear();
        const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
        const day = dateObj.getDate().toString().padStart(2, '0');
        
        return `${year}${month}${day}`;
      }
      
      const formattedDate = formatDateForAPI(document.getElementById('reportDate').value);

      const newEntry = {
        sale: {
          machineid: document.getElementById('machineId').value.trim(),
          batchid: document.getElementById('batchId').value.trim(),
          date: formattedDate,
          hour: hour,
          receiptcount: receiptCount,
          gto: gto,
          gst: ((Number(gto) - Number(discount)) * 0.07).toFixed(2), // Calculate GST at 7%
          discount: discount,
          servicecharge: document.getElementById('serviceCharge').value,
          noofpax: document.getElementById('noofpax').value,
          cash: cash,
          atm: atm,
          visa: visa,
          mastercard: document.getElementById('mastercard').value,
          amex: document.getElementById('amex').value,
          voucher: document.getElementById('voucher').value,
          othersamount: others,
          vatregistered: vatRegistered
        }
      };

      const salesData = JSON.parse(document.getElementById('salesData').value);
      const existingEntryIndex = salesData.sales.findIndex(s => s.sale.date === newEntry.sale.date && s.sale.hour === newEntry.sale.hour);

      if (existingEntryIndex !== -1) {
        salesData.sales[existingEntryIndex] = newEntry;
      } else {
        salesData.sales.push(newEntry);
      }

      document.getElementById('salesData').value = JSON.stringify(salesData, null, 2);
      document.getElementById('manualEntryForm').style.display = 'none';
      alert('Entry đã được lưu.');
    }

    function validatePayload() {
      const salesData = JSON.parse(document.getElementById('salesData').value);
      const rawDate = document.getElementById('reportDate').value;
      
      // Format date to yyyyMMdd để match với payload
      function formatDateForAPI(dateStr) {
        if (!dateStr) return '';
        const dateObj = new Date(dateStr);
        if (isNaN(dateObj.getTime())) return dateStr;
        
        const year = dateObj.getFullYear();
        const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
        const day = dateObj.getDate().toString().padStart(2, '0');
        
        return `${year}${month}${day}`;
      }
      
      const date = formatDateForAPI(rawDate);
      const requiredHours = [];

      for (let i = 0; i < 24; i++) {
        const hour = i.toString().padStart(2, '0');
        if (!salesData.sales.some(s => s.sale.date === date && s.sale.hour === hour)) {
          requiredHours.push(hour);
        }
      }

      if (requiredHours.length === 0) {
        document.getElementById('validationResult').textContent = `✅ Payload đã đủ 24 giờ cho ngày ${date}.`;
        document.getElementById('validationResult').style.backgroundColor = '#d4edda';
        document.getElementById('validationResult').style.color = '#155724';
      } else {
        document.getElementById('validationResult').innerHTML = `❌ Payload thiếu ${requiredHours.length} giờ: ${requiredHours.join(', ')}<br><strong>Lỗi API sẽ là:</strong><br><code>{"status": "error", "errors": [{"status_code": "Daily records", "message": "ERROR: Every day should have 24 Records. Hour 00 to 23. Date :${date}"}]}</code>`;
        document.getElementById('validationResult').style.backgroundColor = '#f8d7da';
        document.getElementById('validationResult').style.color = '#721c24';
      }
      document.getElementById('validationResult').style.display = 'block';
    }

    function fillMissingHours() {
      const salesData = JSON.parse(document.getElementById('salesData').value);
      const rawDate = document.getElementById('reportDate').value;
      
      // Format date to yyyyMMdd
      function formatDateForAPI(dateStr) {
        if (!dateStr) return '';
        const dateObj = new Date(dateStr);
        if (isNaN(dateObj.getTime())) return dateStr;
        
        const year = dateObj.getFullYear();
        const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
        const day = dateObj.getDate().toString().padStart(2, '0');
        
        return `${year}${month}${day}`;
      }
      
      const date = formatDateForAPI(rawDate);
      const missingHours = [];

      for (let i = 0; i < 24; i++) {
        const hour = i.toString().padStart(2, '0');
        if (!salesData.sales.some(s => s.sale.date === date && s.sale.hour === hour)) {
          missingHours.push(hour);
        }
      }

      if (missingHours.length === 0) {
        alert('Không có giờ nào thiếu trong payload.');
        return;
      }

      if (confirm(`Bạn có chắc chắn muốn thêm ${missingHours.length} giờ vào payload không?\n\nCác giờ thiếu: ${missingHours.join(', ')}`)) {
        missingHours.forEach(hour => {
          const newEntry = {
            sale: {
              machineid: document.getElementById('machineId').value.trim(),
              batchid: document.getElementById('batchId').value.trim(),
              date: date,
              hour: hour,
              receiptcount: '0',
              gto: '0.00',
              gst: '0.00',
              discount: '0.00',
              servicecharge: document.getElementById('serviceCharge').value,
              noofpax: document.getElementById('noofpax').value,
              cash: '0.00',
              atm: '0.00',
              visa: '0.00',
              mastercard: document.getElementById('mastercard').value,
              amex: document.getElementById('amex').value,
              voucher: document.getElementById('voucher').value,
              othersamount: '0.00',
              vatregistered: document.getElementById('vatRegistered').value
            }
          };
          salesData.sales.push(newEntry);
        });
        
        // Sort by hour để đảm bảo thứ tự
        salesData.sales.sort((a, b) => a.sale.hour.localeCompare(b.sale.hour));
        
        document.getElementById('salesData').value = JSON.stringify(salesData, null, 2);
        alert(`✅ Đã thêm ${missingHours.length} giờ vào payload. Total entries: ${salesData.sales.length}`);
      }
    }

    function sortPayloadByHour() {
      try {
        const salesData = JSON.parse(document.getElementById('salesData').value);
        if (!salesData.sales || salesData.sales.length === 0) {
          alert('Không có dữ liệu để sắp xếp.');
          return;
        }
        
        salesData.sales.sort((a, b) => a.sale.hour.localeCompare(b.sale.hour));
        document.getElementById('salesData').value = JSON.stringify(salesData, null, 2);
        alert(`✅ Đã sắp xếp ${salesData.sales.length} entries theo thứ tự giờ (00-23).`);
      } catch (error) {
        alert('❌ Lỗi khi parse JSON payload!');
        console.error('Sort error:', error);
      }
    }
  </script>
</body>
</html>
